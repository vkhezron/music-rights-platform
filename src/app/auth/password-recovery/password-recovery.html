<!-- 
  ðŸ” PASSWORD RECOVERY PAGE
  Multi-step recovery flow: Username â†’ Method â†’ Verify â†’ New Password
-->

<div class="recovery-container">
  <!-- Left side: Recovery form -->
  <div class="recovery-form-section">
    
    <!-- Header -->
    <div class="recovery-header">
      <h1 class="logo">
        <lucide-icon [img]="Music" [size]="32" [strokeWidth]="2"></lucide-icon>
        {{ 'APP_NAME' | translate }}
      </h1>
      <h2 class="title">{{ 'AUTH.PASSWORD_RECOVERY' | translate }}</h2>
      <p class="subtitle">{{ 'AUTH.RECOVERY_SUBTITLE' | translate }}</p>
    </div>

    <!-- Step Progress -->
    <div class="step-progress">
      <div [class.active]="currentStep() === 'username'" class="step">
        <span class="step-number">1</span>
        <span class="step-label">{{ 'AUTH.VERIFY_USERNAME' | translate }}</span>
      </div>
      <div class="step-connector" [class.active]="['method', 'verify', 'password', 'success'].includes(currentStep())"></div>
      
      <div [class.active]="currentStep() === 'method'" class="step">
        <span class="step-number">2</span>
        <span class="step-label">{{ 'AUTH.CHOOSE_METHOD' | translate }}</span>
      </div>
      <div class="step-connector" [class.active]="['verify', 'password', 'success'].includes(currentStep())"></div>
      
      <div [class.active]="currentStep() === 'verify'" class="step">
        <span class="step-number">3</span>
        <span class="step-label">{{ 'AUTH.VERIFY_IDENTITY' | translate }}</span>
      </div>
      <div class="step-connector" [class.active]="['password', 'success'].includes(currentStep())"></div>
      
      <div [class.active]="['password', 'success'].includes(currentStep())" class="step">
        <span class="step-number">4</span>
        <span class="step-label">{{ 'AUTH.NEW_PASSWORD' | translate }}</span>
      </div>
    </div>

    <!-- Form Container -->
    <div class="form-container">

      <!-- Error Alert -->
      @if (errorMessage()) {
        <div class="error-alert">
          <lucide-icon [img]="AlertCircle" [size]="20" class="error-icon"></lucide-icon>
          <span>{{ errorMessage() | translate }}</span>
        </div>
      }

      <!-- Step 1: Username Verification -->
      @if (currentStep() === 'username') {
        <form [formGroup]="usernameForm" (ngSubmit)="submitUsername()" class="recovery-form">
          <div class="form-group">
            <label for="username">{{ 'AUTH.USERNAME' | translate }}</label>
            <div class="input-wrapper">
              <lucide-icon [img]="Lock" [size]="18" class="input-icon"></lucide-icon>
              <input
                id="username"
                type="text"
                formControlName="username"
                class="form-input"
                [class.error]="hasError(usernameForm, 'username', 'required') || hasError(usernameForm, 'username', 'minlength')"
                placeholder="your_username"
              />
            </div>
            @if (hasError(usernameForm, 'username', 'required')) {
              <div class="error-message">{{ 'AUTH.USERNAME_REQUIRED' | translate }}</div>
            }
            @if (hasError(usernameForm, 'username', 'minlength')) {
              <div class="error-message">{{ 'AUTH.USERNAME_MIN_LENGTH' | translate }}</div>
            }
          </div>

          <button 
            type="submit" 
            class="primary-button"
            [disabled]="usernameForm.invalid || isLoading()"
          >
            @if (isLoading()) {
              <span class="loading">
                <span class="spinner"></span>
                {{ 'AUTH.VERIFYING' | translate }}
              </span>
            } @else {
              {{ 'AUTH.CONTINUE' | translate }}
            }
          </button>

          <div class="back-to-login">
            <a routerLink="/auth/login" class="link">
              <lucide-icon [img]="ArrowLeft" [size]="16"></lucide-icon>
              {{ 'AUTH.BACK_TO_LOGIN' | translate }}
            </a>
          </div>
        </form>
      }

      <!-- Step 2: Recovery Method Selection -->
      @if (currentStep() === 'method') {
        <form [formGroup]="recoveryMethodForm" (ngSubmit)="submitRecoveryMethod()" class="recovery-form">
          <div class="form-group">
            <label>{{ 'AUTH.CHOOSE_RECOVERY_METHOD' | translate }}</label>
            <div class="method-options">
              
              <!-- Option 1: Security Questions -->
              <label class="method-option">
                <input 
                  type="radio" 
                  formControlName="method" 
                  value="questions"
                  class="radio-input"
                />
                <div class="method-content">
                  <lucide-icon [img]="MessageSquare" [size]="20"></lucide-icon>
                  <div>
                    <span class="method-title">{{ 'AUTH.RECOVERY_WITH_QUESTIONS' | translate }}</span>
                    <span class="method-desc">{{ 'AUTH.RECOVERY_QUESTIONS_DESC' | translate }}</span>
                  </div>
                </div>
              </label>

              <!-- Option 2: Recovery Code -->
              <label class="method-option">
                <input 
                  type="radio" 
                  formControlName="method" 
                  value="code"
                  class="radio-input"
                />
                <div class="method-content">
                  <lucide-icon [img]="Key" [size]="20"></lucide-icon>
                  <div>
                    <span class="method-title">{{ 'AUTH.RECOVERY_WITH_CODE' | translate }}</span>
                    <span class="method-desc">{{ 'AUTH.RECOVERY_CODE_DESC' | translate }}</span>
                  </div>
                </div>
              </label>

            </div>
          </div>

          <button 
            type="submit" 
            class="primary-button"
            [disabled]="recoveryMethodForm.invalid || isLoading()"
          >
            {{ 'AUTH.CONTINUE' | translate }}
          </button>

          <button 
            type="button" 
            class="secondary-button"
            (click)="goBack()"
            [disabled]="isLoading()"
          >
            {{ 'AUTH.BACK' | translate }}
          </button>
        </form>
      }

      <!-- Step 3: Identity Verification -->
      @if (currentStep() === 'verify') {
        <!-- Verify with Security Questions -->
        @if (recoveryMethod() === 'questions') {
          <form [formGroup]="questionsForm" (ngSubmit)="submitSecurityQuestions()" class="recovery-form">
            <div class="info-box">
              <lucide-icon [img]="MessageSquare" [size]="18"></lucide-icon>
              <span>{{ 'AUTH.ANSWER_SECURITY_QUESTIONS' | translate }}</span>
            </div>

            <!-- Question 1 -->
            <div class="form-group">
              <label for="answer1">{{ 'AUTH.QUESTION' | translate }} 1</label>
              <p class="question-text">{{ selectedQuestion1Key() | translate }}</p>
              <input
                id="answer1"
                type="text"
                formControlName="answer1"
                class="form-input"
                [class.error]="hasError(questionsForm, 'answer1', 'required')"
                placeholder="{{ 'AUTH.YOUR_ANSWER' | translate }}"
              />
              @if (hasError(questionsForm, 'answer1', 'required')) {
                <div class="error-message">{{ 'AUTH.REQUIRED_FIELD' | translate }}</div>
              }
            </div>

            <!-- Question 2 -->
            <div class="form-group">
              <label for="answer2">{{ 'AUTH.QUESTION' | translate }} 2</label>
              <p class="question-text">{{ selectedQuestion2Key() | translate }}</p>
              <input
                id="answer2"
                type="text"
                formControlName="answer2"
                class="form-input"
                [class.error]="hasError(questionsForm, 'answer2', 'required')"
                placeholder="{{ 'AUTH.YOUR_ANSWER' | translate }}"
              />
              @if (hasError(questionsForm, 'answer2', 'required')) {
                <div class="error-message">{{ 'AUTH.REQUIRED_FIELD' | translate }}</div>
              }
            </div>

            <button 
              type="submit" 
              class="primary-button"
              [disabled]="questionsForm.invalid || isLoading()"
            >
              @if (isLoading()) {
                <span class="loading">
                  <span class="spinner"></span>
                  {{ 'AUTH.VERIFYING' | translate }}
                </span>
              } @else {
                {{ 'AUTH.VERIFY_ANSWERS' | translate }}
              }
            </button>

            <button 
              type="button" 
              class="secondary-button"
              (click)="goBack()"
              [disabled]="isLoading()"
            >
              {{ 'AUTH.BACK' | translate }}
            </button>
          </form>
        }

        <!-- Verify with Recovery Code -->
        @if (recoveryMethod() === 'code') {
          <form [formGroup]="codeForm" (ngSubmit)="submitRecoveryCode()" class="recovery-form">
            <div class="info-box">
              <lucide-icon [img]="Key" [size]="18"></lucide-icon>
              <span>{{ 'AUTH.ENTER_RECOVERY_CODE' | translate }}</span>
            </div>

            <div class="form-group">
              <label for="recoveryCode">{{ 'AUTH.RECOVERY_CODE' | translate }}</label>
              <input
                id="recoveryCode"
                type="text"
                formControlName="recoveryCode"
                class="form-input"
                [class.error]="hasError(codeForm, 'recoveryCode', 'required')"
                placeholder="ABC-DEF123"
                pattern="[A-Z0-9\-]{7,}"
              />
              <small class="help-text">{{ 'AUTH.CODE_FORMAT_HINT' | translate }}</small>
              @if (hasError(codeForm, 'recoveryCode', 'required')) {
                <div class="error-message">{{ 'AUTH.REQUIRED_FIELD' | translate }}</div>
              }
              @if (hasError(codeForm, 'recoveryCode', 'pattern')) {
                <div class="error-message">{{ 'AUTH.INVALID_RECOVERY_CODE' | translate }}</div>
              }
            </div>

            <button 
              type="submit" 
              class="primary-button"
              [disabled]="codeForm.invalid || isLoading()"
            >
              @if (isLoading()) {
                <span class="loading">
                  <span class="spinner"></span>
                  {{ 'AUTH.VERIFYING' | translate }}
                </span>
              } @else {
                {{ 'AUTH.VERIFY_CODE' | translate }}
              }
            </button>

            <button 
              type="button" 
              class="secondary-button"
              (click)="goBack()"
              [disabled]="isLoading()"
            >
              {{ 'AUTH.BACK' | translate }}
            </button>
          </form>
        }

      }

      <!-- Step 4: Set New Password -->
      @if (currentStep() === 'password') {
        <form [formGroup]="passwordForm" (ngSubmit)="submitNewPassword()" class="recovery-form">
          <div class="info-box">
            <lucide-icon [img]="Lock" [size]="18"></lucide-icon>
            <span>{{ 'AUTH.CREATE_NEW_PASSWORD' | translate }}</span>
          </div>

          <!-- Password Input -->
          <div class="form-group">
            <label for="password">{{ 'AUTH.NEW_PASSWORD' | translate }}</label>
            <input
              id="password"
              type="password"
              formControlName="password"
              class="form-input"
              [class.error]="hasError(passwordForm, 'password', 'required') || hasError(passwordForm, 'password', 'minlength')"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            <small class="help-text">{{ 'AUTH.PASSWORD_MIN_8_CHARS' | translate }}</small>
            @if (hasError(passwordForm, 'password', 'required')) {
              <div class="error-message">{{ 'AUTH.REQUIRED_FIELD' | translate }}</div>
            }
            @if (hasError(passwordForm, 'password', 'minlength')) {
              <div class="error-message">{{ 'AUTH.PASSWORD_MIN_LENGTH' | translate }}</div>
            }
          </div>

          <!-- Confirm Password Input -->
          <div class="form-group">
            <label for="confirmPassword">{{ 'AUTH.CONFIRM_PASSWORD' | translate }}</label>
            <input
              id="confirmPassword"
              type="password"
              formControlName="confirmPassword"
              class="form-input"
              [class.error]="hasError(passwordForm, 'confirmPassword', 'required')"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
            @if (hasError(passwordForm, 'confirmPassword', 'required')) {
              <div class="error-message">{{ 'AUTH.REQUIRED_FIELD' | translate }}</div>
            }
          </div>

          <button 
            type="submit" 
            class="primary-button"
            [disabled]="passwordForm.invalid || isLoading()"
          >
            @if (isLoading()) {
              <span class="loading">
                <span class="spinner"></span>
                {{ 'AUTH.RESETTING_PASSWORD' | translate }}
              </span>
            } @else {
              {{ 'AUTH.RESET_PASSWORD' | translate }}
            }
          </button>

          <button 
            type="button" 
            class="secondary-button"
            (click)="goBack()"
            [disabled]="isLoading()"
          >
            {{ 'AUTH.BACK' | translate }}
          </button>
        </form>
      }

      <!-- Step 5: Success -->
      @if (currentStep() === 'success') {
        <div class="success-container">
          <lucide-icon [img]="CheckCircle" [size]="48" class="success-icon"></lucide-icon>
          <h3>{{ 'AUTH.PASSWORD_RESET_SUCCESS' | translate }}</h3>
          <p>{{ 'AUTH.PASSWORD_RESET_SUCCESS_MESSAGE' | translate }}</p>
          
          <button 
            type="button" 
            class="primary-button"
            (click)="returnToLogin()"
          >
            {{ 'AUTH.RETURN_TO_LOGIN' | translate }}
          </button>
        </div>
      }

    </div>
  </div>

  <!-- Right side: Branding -->
  <div class="branding-section">
    <div class="branding-content">
      <h2>{{ 'AUTH.SECURE_RECOVERY' | translate }}</h2>
      <p>{{ 'AUTH.NO_EMAIL_REQUIRED' | translate }}</p>
      
      <div class="feature-list">
        <div class="feature">
          <lucide-icon [img]="MessageSquare" [size]="20"></lucide-icon>
          <span>{{ 'AUTH.FEATURE_SECURITY_QUESTIONS' | translate }}</span>
        </div>
        <div class="feature">
          <lucide-icon [img]="Key" [size]="20"></lucide-icon>
          <span>{{ 'AUTH.FEATURE_BACKUP_CODES' | translate }}</span>
        </div>
        <div class="feature">
          <lucide-icon [img]="Lock" [size]="20"></lucide-icon>
          <span>{{ 'AUTH.FEATURE_STRONG_SECURITY' | translate }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
