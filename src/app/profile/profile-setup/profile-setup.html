<div class="profile-setup-container">
  <div class="setup-card">
    
    <!-- Header -->
    <div class="setup-header">
      <h1 class="setup-title">{{ 'PROFILE.SETUP_TITLE' | translate }}</h1>
      <p class="setup-subtitle">{{ 'PROFILE.SETUP_SUBTITLE' | translate }}</p>
    </div>

    <!-- Form -->
    <form [formGroup]="profileForm" (ngSubmit)="onSubmit()" class="setup-form">
      

      <!-- Error Message -->
      @if (errorMessage()) {
        <div class="error-alert">
          <lucide-icon [img]="AlertCircle" [size]="20" class="error-icon"></lucide-icon>
          <span>{{ errorMessage() | translate }}</span>
        </div>
      }

      <!-- REQUIRED SECTION -->
      <div class="form-section">
        <h2 class="section-title">{{ 'PROFILE.REQUIRED_INFO' | translate }}</h2>

        <!-- Nickname -->
        <div class="form-group">
          <label for="nickname" class="required">
            {{ 'PROFILE.NICKNAME' | translate }}
          </label>
          <div class="input-with-validation">
            <input
              id="nickname"
              type="text"
              formControlName="nickname"
              class="form-input"
              [class.error]="hasError('nickname', 'required') || hasError('nickname', 'minlength')"
              [class.success]="nicknameAvailable() === true"
              placeholder="Enter your display name"
            />
            @if (nicknameCheckLoading()) {
              <span class="validation-icon loading">
                <div class="mini-spinner"></div>
              </span>
            }
            @if (nicknameAvailable() === true) {
              <span class="validation-icon success">
                <lucide-icon [img]="Check" [size]="16"></lucide-icon>
              </span>
            }
            @if (nicknameAvailable() === false) {
              <span class="validation-icon error">
                <lucide-icon [img]="X" [size]="16"></lucide-icon>
              </span>
            }
          </div>
          
          @if (hasError('nickname', 'required')) {
            <div class="error-message">
              {{ 'PROFILE.NICKNAME_REQUIRED' | translate }}
            </div>
          }
          @if (hasError('nickname', 'minlength')) {
            <div class="error-message">
              {{ 'PROFILE.NICKNAME_MIN_LENGTH' | translate }}
            </div>
          }
          @if (nicknameAvailable() === true) {
            <div class="success-message">
              {{ 'PROFILE.NICKNAME_AVAILABLE' | translate }}
            </div>
          }
          @if (nicknameAvailable() === false) {
            <div class="error-message">
              {{ 'PROFILE.NICKNAME_TAKEN' | translate }}
            </div>
          }
        </div>

        <!-- Primary Role -->
        <div class="form-group">
          <label for="primary_role" class="required">
            {{ 'PROFILE.PRIMARY_ROLE' | translate }}
          </label>
          <input
            type="text"
            class="form-input role-search-input"
            [value]="primaryRoleSearch()"
            (input)="onPrimaryRoleSearch($any($event.target).value)"
            [placeholder]="'PROFILE.PRIMARY_ROLE_SEARCH_PLACEHOLDER' | translate"
          />
          <select
            id="primary_role"
            formControlName="primary_role"
            class="form-select"
            [class.error]="hasError('primary_role', 'required')"
          >
            <option value="">{{ 'role.select' | translate }}</option>
            @for (group of filteredPrimaryRoleGroups(); track group.id) {
              <optgroup [label]="group.labelKey | translate">
                @for (role of group.roles; track role) {
                  <option [value]="role">{{ ('role.' + role) | translate }}</option>
                }
              </optgroup>
            }
            <option value="other">{{ 'role.other' | translate }}</option>
          </select>
          @if (filteredPrimaryRoleGroups().length === 0 && primaryRoleSearch()) {
            <div class="no-role-results">
              {{ 'PROFILE.ROLE_SEARCH_NO_RESULTS' | translate }}
            </div>
          }
          @if (hasError('primary_role', 'required')) {
            <div class="error-message">
              {{ 'PROFILE.PRIMARY_ROLE_REQUIRED' | translate }}
            </div>
          }
        </div>


        <!-- Custom Role Text (shown if "Other" selected) -->
        @if (profileForm.get('primary_role')?.value === 'other') {
          <div class="form-group">
            <label for="custom_role_text" class="required">
              {{ 'PROFILE.SPECIFY_ROLE' | translate }}
            </label>
            <input
              id="custom_role_text"
              type="text"
              formControlName="custom_role_text"
              class="form-input"
              placeholder="Enter your specific role"
            />
            @if (hasError('custom_role_text', 'required')) {
              <div class="error-message">
                {{ 'PROFILE.CUSTOM_ROLE_REQUIRED' | translate }}
              </div>
            }
          </div>
        }
      </div>

      <!-- OPTIONAL SECTION -->
      <div class="form-section">
        <div class="section-header" (click)="toggleOptionalFields()">
          <h2 class="section-title">{{ 'PROFILE.OPTIONAL_INFO' | translate }}</h2>
          <button type="button" class="toggle-button">
            <lucide-icon [img]="showOptionalFields() ? ChevronDown : ChevronRight" [size]="20"></lucide-icon>
          </button>
        </div>

        @if (showOptionalFields()) {
          <div class="optional-fields">
            
            <!-- Secondary Roles -->
            <div class="form-group">
              <label class="group-label">{{ 'PROFILE.SECONDARY_ROLES' | translate }}</label>
              <input
                type="text"
                class="form-input role-search-input"
                [value]="secondaryRoleSearch()"
                (input)="onSecondaryRoleSearch($any($event.target).value)"
                [placeholder]="'PROFILE.SECONDARY_ROLE_SEARCH_PLACEHOLDER' | translate"
              />

              @for (group of filteredSecondaryRoleGroups(); track group.id) {
                <div class="role-category">
                  <h3 class="category-title">{{ group.labelKey | translate }}</h3>
                  <div class="checkbox-grid">
                    @for (role of group.roles; track role) {
                      <label class="checkbox-label">
                        <input
                          type="checkbox"
                          [checked]="isSecondaryRoleSelected(role)"
                          (change)="toggleSecondaryRole(role)"
                        />
                        <span>{{ ('role.' + role) | translate }}</span>
                      </label>
                    }
                  </div>
                </div>
              }

              @if (filteredSecondaryRoleGroups().length === 0 && secondaryRoleSearch()) {
                <div class="no-role-results">
                  {{ 'PROFILE.ROLE_SEARCH_NO_RESULTS' | translate }}
                </div>
              }
            </div>

            <!-- Bio -->
            <div class="form-group">
              <label for="bio">{{ 'PROFILE.BIO' | translate }}</label>
              <textarea
                id="bio"
                formControlName="bio"
                class="form-textarea"
                rows="4"
                maxlength="500"
                placeholder="Tell us about yourself..."
              ></textarea>
              <div class="char-count">
                {{ profileForm.get('bio')?.value?.length || 0 }} / 500
              </div>
            </div>

            <!-- Primary Language -->
            <div class="form-group">
              <label for="primary_language">
                {{ 'PROFILE.PRIMARY_LANGUAGE' | translate }}
              </label>
              <select
                id="primary_language"
                formControlName="primary_language"
                class="form-select"
              >
                @for (lang of languages; track lang.code) {
                  <option [value]="lang.code">
                    {{ lang.name }}
                  </option>
                }
              </select>
            </div>

            <!-- Social Links -->
            <div class="form-group">
              <label class="group-label">{{ 'PROFILE.SOCIAL_LINKS' | translate }}</label>
              
              @for (platform of socialPlatforms; track platform.name) {
                <div class="social-input-row">
                  <div class="platform-label">{{ platform.name }}</div>
                  <input
                    [id]="getControlName(platform.name)"
                    type="text"
                    [formControlName]="getControlName(platform.name)"
                    class="form-input"
                    [placeholder]="platform.placeholder"
                  />
                  <button 
                    type="button"
                    class="copy-btn"
                    [disabled]="!profileForm.get(getControlName(platform.name))?.value"
                    (click)="copySocialLink(platform.name, profileForm.get(getControlName(platform.name))?.value)"
                    [title]="'Copy ' + platform.name">
                    <lucide-icon [img]="Copy" [size]="18"></lucide-icon>
                  </button>
                </div>
              }
            </div>
          </div>
        }
      </div>

      <!-- Action Buttons -->
      <div class="form-actions">
        @if (!showOptionalFields()) {
          <button
            type="button"
            class="skip-button"
            (click)="skipOptionalFields()"
            [disabled]="isLoading()"
          >
            {{ 'PROFILE.SKIP_OPTIONAL' | translate }}
          </button>
        }
        
        <button
          type="submit"
          class="submit-button"
          [disabled]="isLoading() || nicknameAvailable() !== true"
        >
          @if (!isLoading()) {
            <span>
              {{ showOptionalFields() ? ('PROFILE.SAVE_PROFILE' | translate) : ('PROFILE.CONTINUE' | translate) }}
            </span>
          }
          @if (isLoading()) {
            <span class="loading">
              <span class="spinner"></span>
              {{ 'COMMON.LOADING' | translate }}
            </span>
          }
        </button>
      </div>
    
    </form>
  </div>
</div>