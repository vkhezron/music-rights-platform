<div class="split-editor-container">
  <div class="split-editor-header">
    <div class="header-left">
      <button class="back-btn" type="button" (click)="cancel()" [disabled]="isSaving() || isLoading()">
        {{ 'COMMON.BACK' | translate }}
      </button>
      <div class="header-info">
        <h1>{{ work()?.work_title || ('SPLITS.SPLIT_EDITOR' | translate) }}</h1>
        <p>Review and balance rights splits.</p>
      </div>
    </div>
    <div class="header-actions">
      <button
        type="button"
        class="secondary-btn history-btn"
        (click)="openChangeHistory()"
        [disabled]="isSaving() || isLoading() || changeHistoryLoading()"
      >
        <lucide-icon [img]="History" [size]="18"></lucide-icon>
        <span>{{ 'SPLITS.VIEW_CHANGES' | translate }}</span>
      </button>
      <button
        type="button"
        class="secondary-btn"
        (click)="downloadPdf()"
        [disabled]="isSaving() || isLoading()"
      >
        {{ 'COMMON.DOWNLOAD' | translate }}
      </button>
      <button
        type="button"
        class="primary-btn"
        (click)="saveSplits()"
        [disabled]="saveDisabled()"
        [attr.title]="saveBlockedReason() || null"
      >
        @if (!isSaving()) {
          {{ 'COMMON.SAVE' | translate }}
        } @else {
          {{ 'COMMON.SAVING' | translate }}...
        }
      </button>
    </div>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">{{ errorMessage() }}</div>
  }

  @if (successMessage()) {
    <div class="alert alert-success">{{ successMessage() }}</div>
  }

  @if (isLoading()) {
    <div class="loading-state">
      <div class="spinner"></div>
      <p>{{ 'COMMON.LOADING' | translate }}</p>
    </div>
  } @else {
    <div class="split-totals">
      <div
        class="total-card"
        [class.progress-valid]="lyricsStatus().state === 'complete'"
        [class.progress-warning]="lyricsStatus().state === 'over'"
        [class.progress-error]="lyricsStatus().state === 'over'"
        [class.progress-idle]="lyricsStatus().state !== 'complete' && lyricsStatus().state !== 'over'"
      >
        <span class="total-card__label">{{ 'PROTOCOL.LYRICS' | translate }}</span>
        <span class="total-card__value">{{ lyricsTotal() | number:'1.0-2' }}%</span>
        <p
          class="total-card__hint"
          [class.total-card__hint--alert]="lyricsStatus().state === 'under' || lyricsStatus().state === 'over'"
          [class.total-card__hint--info]="!lyricsStatus().hasEntries"
        >
          {{ totalHint(lyricsStatus()) }}
        </p>
      </div>
      <div
        class="total-card"
        [class.progress-valid]="musicStatus().state === 'complete'"
        [class.progress-warning]="musicStatus().state === 'over'"
        [class.progress-error]="musicStatus().state === 'over'"
        [class.progress-idle]="musicStatus().state !== 'complete' && musicStatus().state !== 'over'"
      >
        <span class="total-card__label">{{ 'PROTOCOL.MUSIC' | translate }}</span>
        <span class="total-card__value">{{ musicTotal() | number:'1.0-2' }}%</span>
        <p
          class="total-card__hint"
          [class.total-card__hint--alert]="musicStatus().state === 'under' || musicStatus().state === 'over'"
          [class.total-card__hint--info]="!musicStatus().hasEntries"
        >
          {{ totalHint(musicStatus()) }}
        </p>
      </div>
      <div
        class="total-card"
        [class.progress-valid]="neighbouringStatus().state === 'complete'"
        [class.progress-warning]="neighbouringStatus().state === 'over'"
        [class.progress-error]="neighbouringStatus().state === 'over'"
        [class.progress-idle]="neighbouringStatus().state !== 'complete' && neighbouringStatus().state !== 'over'"
      >
        <span class="total-card__label">{{ 'SPLITS.NEIGHBORING_RIGHTS' | translate }}</span>
        <span class="total-card__value">{{ neighbouringTotal() | number:'1.0-2' }}%</span>
        <p
          class="total-card__hint"
          [class.total-card__hint--alert]="neighbouringStatus().state === 'under' || neighbouringStatus().state === 'over'"
          [class.total-card__hint--info]="!neighbouringStatus().hasEntries"
        >
          {{ totalHint(neighbouringStatus()) }}
        </p>
      </div>
    </div>

    @if (totalsAlertMessage()) {
      <div class="split-validation-alert">
        {{ totalsAlertMessage() }}
      </div>
    }

    <section class="split-section">
      <header class="split-section__header">
        <div>
          <h2>{{ 'PROTOCOL.LYRICS' | translate }}</h2>
          <p>Capture lyric ownership for every contributor.</p>
        </div>
        <span class="split-section__total">{{ lyricsTotal() | number:'1.0-2' }}%</span>
      </header>

      <div class="split-section__entries">
        @if (!lyricsEntries().length) {
          <p class="split-section__empty">{{ 'SPLITS.NO_IP_SPLITS_YET' | translate }}</p>
        }

        @for (entry of lyricsEntries(); track trackEntry($index, entry)) {
          <app-split-entry-card
            [entry]="entry"
            (entryUpdated)="onEntryUpdated($event)"
            (entryRemoved)="onEntryRemoved($event)"
          ></app-split-entry-card>
        }
      </div>

      <div class="split-section__actions">
        <button
          type="button"
          class="action-btn"
          (click)="startQrFlow('lyrics')"
          [disabled]="isLoading() || isSaving()"
        >
          {{ 'SPLITS.ADD_NEW_BY_QR' | translate }}
        </button>
        <button type="button" class="action-btn" (click)="addManualEntry('lyrics')">
          {{ 'SPLITS.ADD_NEW_RIGHTSHOLDER_MANUALLY' | translate }}
        </button>
        @if (shouldShowAddMe('lyrics')) {
          <button type="button" class="action-btn" (click)="addSelfEntry('lyrics')">
            {{ 'SPLITS.ADD_ME' | translate }}
          </button>
        }
      </div>
    </section>

    <section class="split-section">
      <header class="split-section__header">
        <div>
          <h2>{{ 'PROTOCOL.MUSIC' | translate }}</h2>
          <p>Document melodic and harmonic contributions.</p>
        </div>
        <span class="split-section__total">{{ musicTotal() | number:'1.0-2' }}%</span>
      </header>

      <div class="split-section__entries">
        @if (!musicEntries().length) {
          <p class="split-section__empty">{{ 'SPLITS.NO_IP_SPLITS_YET' | translate }}</p>
        }

        @for (entry of musicEntries(); track trackEntry($index, entry)) {
          <app-split-entry-card
            [entry]="entry"
            [showContributionFlags]="true"
            (entryUpdated)="onEntryUpdated($event)"
            (entryRemoved)="onEntryRemoved($event)"
          ></app-split-entry-card>
        }
      </div>

      <div class="split-section__actions">
        <button
          type="button"
          class="action-btn"
          (click)="startQrFlow('music')"
          [disabled]="isLoading() || isSaving()"
        >
          {{ 'SPLITS.ADD_NEW_BY_QR' | translate }}
        </button>
        <button type="button" class="action-btn" (click)="addManualEntry('music')">
          {{ 'SPLITS.ADD_NEW_RIGHTSHOLDER_MANUALLY' | translate }}
        </button>
        @if (shouldShowAddMe('music')) {
          <button type="button" class="action-btn" (click)="addSelfEntry('music')">
            {{ 'SPLITS.ADD_ME' | translate }}
          </button>
        }
      </div>
    </section>

    <section class="split-section">
      <header class="split-section__header">
        <div>
          <h2>{{ 'SPLITS.NEIGHBORING_RIGHTS' | translate }}</h2>
          <p>Track performance and master recording parties.</p>
        </div>
        <span class="split-section__total">{{ neighbouringTotal() | number:'1.0-2' }}%</span>
      </header>

      <div class="split-section__entries">
        @if (!neighbouringEntries().length) {
          <p class="split-section__empty">{{ 'SPLITS.NO_NEIGHBORING_SPLITS_YET' | translate }}</p>
        }

        @for (entry of neighbouringEntries(); track trackEntry($index, entry)) {
          <app-split-entry-card
            [entry]="entry"
            [showRoleSelector]="true"
            (entryUpdated)="onEntryUpdated($event)"
            (entryRemoved)="onEntryRemoved($event)"
          ></app-split-entry-card>
        }
      </div>

      <div class="split-section__actions">
        <button
          type="button"
          class="action-btn"
          (click)="startQrFlow('neighbouring')"
          [disabled]="isLoading() || isSaving()"
        >
          {{ 'SPLITS.ADD_NEW_BY_QR' | translate }}
        </button>
        <button type="button" class="action-btn" (click)="addManualEntry('neighbouring')">
          {{ 'SPLITS.ADD_NEW_RIGHTSHOLDER_MANUALLY' | translate }}
        </button>
        @if (shouldShowAddMe('neighbouring')) {
          <button type="button" class="action-btn" (click)="addSelfEntry('neighbouring')">
            {{ 'SPLITS.ADD_ME' | translate }}
          </button>
        }
      </div>
    </section>
  }

  @if (isQrModalOpen()) {
    <div class="qr-modal">
      <div class="qr-modal__content">
        <header>
          <h3>{{ 'SPLITS.SCAN_QR_CODE' | translate }}</h3>
          <button type="button" class="qr-modal__close" (click)="stopQrFlow()">Ã—</button>
        </header>
        @if (qrError()) {
          <div class="alert alert-error">{{ qrError() }}</div>
        }
        <video #qrVideo autoplay muted playsinline></video>
        <button type="button" class="secondary-btn" (click)="stopQrFlow()">
          Close
        </button>
      </div>
    </div>
  }

  @if (showChangeHistory()) {
    <div class="history-overlay" role="dialog" aria-modal="true">
      <div class="history-dialog">
        <header class="history-header">
          <h3>{{ 'SPLITS.CHANGE_HISTORY.TITLE' | translate }}</h3>
          <p>{{ 'SPLITS.CHANGE_HISTORY.DESCRIPTION' | translate }}</p>
        </header>

        <div class="history-content">
          @if (changeHistoryLoading()) {
            <div class="history-loading">
              <span class="spinner"></span>
              <span>{{ 'COMMON.LOADING' | translate }}</span>
            </div>
          } @else if (changeHistoryError()) {
            <div class="history-error">{{ changeHistoryError() }}</div>
          } @else {
            @if (changeHistory().length) {
              <div class="history-grid">
                <div class="history-grid__headers">
                  <span class="history-grid__header">{{ 'SPLITS.CHANGE_HISTORY.CHANGED_FIELD' | translate }}</span>
                  <span class="history-grid__header">{{ 'SPLITS.CHANGE_HISTORY.OLD_VALUE' | translate }}</span>
                  <span class="history-grid__header">{{ 'SPLITS.CHANGE_HISTORY.NEW_VALUE' | translate }}</span>
                  <span class="history-grid__header">{{ 'SPLITS.CHANGE_HISTORY.CHANGED_BY' | translate }}</span>
                  <span class="history-grid__header">{{ 'SPLITS.CHANGE_HISTORY.CHANGED_AT' | translate }}</span>
                </div>

                @for (entry of changeHistory(); track entry.id) {
                  <div class="history-grid__row">
                    <div class="history-grid__cell history-grid__cell--field">
                      <span class="history-grid__field-name">
                        {{ describeChangedField(entry) || ('SPLITS.CHANGE_HISTORY.UNKNOWN_FIELD' | translate) }}
                      </span>
                      <div class="history-grid__field-meta">
                        <span class="history-grid__pill">
                          {{ getChangeTypeTranslationKey(entry.change_type) | translate }}
                        </span>
                        @if (entry.split_id && entry.field_changed !== 'split_id') {
                          <span class="history-grid__meta">
                            {{ 'SPLITS.CHANGE_HISTORY.SPLIT_LABEL' | translate:{ value: entry.split_id } }}
                          </span>
                        }
                      </div>
                    </div>

                    <div class="history-grid__cell history-grid__cell--value">
                      <div class="history-grid__value">
                        {{ formatChangeValue(entry.old_value) || ('SPLITS.CHANGE_HISTORY.EMPTY' | translate) }}
                      </div>
                    </div>

                    <div class="history-grid__cell history-grid__cell--value">
                      <div class="history-grid__value">
                        {{ formatChangeValue(entry.new_value) || ('SPLITS.CHANGE_HISTORY.EMPTY' | translate) }}
                      </div>
                    </div>

                    <div class="history-grid__cell history-grid__cell--by">
                      <span [title]="entry.changed_by || null">
                        {{ entry.changed_by_nickname || entry.changed_by_display_name || ('SPLITS.CHANGE_HISTORY.UNKNOWN_USER' | translate) }}
                      </span>
                    </div>

                    <div class="history-grid__cell history-grid__cell--date">
                      <time>{{ entry.changed_at | date:'medium' }}</time>
                    </div>

                    @if (entry.change_summary || entry.notes) {
                      <div class="history-grid__detail">
                        @if (entry.change_summary) {
                          <div class="history-grid__detail-item">
                            <span class="history-grid__detail-label">{{ 'SPLITS.CHANGE_HISTORY.SUMMARY' | translate }}</span>
                            <p class="history-grid__detail-text">{{ entry.change_summary }}</p>
                          </div>
                        }
                        @if (entry.notes) {
                          <div class="history-grid__detail-item">
                            <span class="history-grid__detail-label">{{ 'SPLITS.CHANGE_HISTORY.NOTES' | translate }}</span>
                            <p class="history-grid__detail-text">{{ entry.notes }}</p>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              <div class="history-empty">
                {{ 'SPLITS.CHANGE_HISTORY.EMPTY_STATE' | translate }}
              </div>
            }
          }
        </div>

        <footer class="history-actions">
          <button type="button" class="history-close-btn" (click)="closeChangeHistory()">
            {{ 'COMMON.CLOSE' | translate }}
          </button>
        </footer>
      </div>
    </div>
  }

</div>

